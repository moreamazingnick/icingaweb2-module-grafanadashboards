<?php

/* Originally from Icinga Web 2 Elasticsearch Module (c) 2017 Icinga Development Team | GPLv2+ */
/* generated by icingaweb2-module-scaffoldbuilder | GPLv2+ */

namespace Icinga\Module\Grafanadashboards;

use Icinga\Application\Config;
use Icinga\Application\Modules\Module;
use Icinga\Data\ConfigObject;
use Icinga\Repository\IniRepository;

class InstanceIniRepository extends IniRepository
{

    public function __construct(Config $ds = null)
    {
        $this->queryColumns['instance']=array_keys($this->getColumnDefinitions());
        parent::__construct($ds);
    }
    protected $configs = [
        'instance' => [
            'name'      => 'instance',
            'keyColumn' => 'name',
            'module'    => 'grafanadashboards'
        ]
    ];

    protected $queryColumns = ['instance' => []];
    protected $protectedFields = array();
    protected $triggers = array('instance');
    /**
     * Reset every protected field to its old value if updated to ""
     * Nessesary for password leakage prevention
     * @param   ConfigObject    $old
     * @param   ConfigObject    $new
     *
     * @return  ConfigObject
     */
    protected function onUpdateInstance(ConfigObject $old, ConfigObject $new)
    {

        foreach($this->protectedFields as $field){

            if( in_array($field, $new->keys()) && in_array($field, $old->keys()) && $new->get($field) ==""){
                $new->{$field} =  $old->get($field);
            }
        }
        return $new;
    }

    public function getColumnDefinitions(): array
    {
        if(
            Module::exists('grafana')
            && version_compare(Module::get('grafana')->getVersion(), '3.1.0', '>=')
        ){
            $multiOptions= ['jwt'=>'JwtAuth','grafanamodule'=>'GrafanaModule','none'=>'None'];
            $description= t('Instance Type (GrafanaModule/JwtAuth/None)');
        }else{
            $multiOptions= ['jwt'=>'JwtAuth','none'=>'None'];
            $description= t('Instance Type (JwtAuth/None)');
        }
        return [
            'name'=>[
                'fieldtype'=>'text',
                'label'=>'Name',
                'description'=>t('A Name of the grafana instance'),
                'required'=>true
            ],
            'url'=>[
                'fieldtype'=>'text',
                'label'=>'Url',
                'description'=>t('The Url of the instance, for example https://monitoring.local or https://monitoring.local/grafana'),
                'required'=>true
            ],
            'type'=>[
                'fieldtype'=>'select',
                'label'=>'Type',
                'multiOptions'=>$multiOptions,
                'description'=>$description,
                'required'=>true,
            ],
            'apikey'=>[
                'fieldtype'=>'password',
                'label'=>'API Key',
                'description'=>t('The api key of a service user')
            ],
            'default_timeframe'=>[
                'fieldtype'=>'number',
                'label'=>'Default Timeframe',
                'description'=>t('The default timeframe for the dashboards')
            ],
            'disable_ssl'=>[
                'fieldtype'=>'checkbox',
                'label'=>t('Disable SSL verification'),
                'description'=>t('Enable or disable SSL verification'),
            ],

        ];
    }
    public function setProtectedFields($array){
        $this->protectedFields=$array;

    }

    public function getIdentifierName(){
        return $this->configs['instance']['keyColumn'];
    }
}
